% -------------------------------------------------------------------
% The purpose of the following program is to define modular dates, a generalization of
% Gregorian dates where the day and month can take on any integral value. They allow you
% to do things like specify a date relative to the end of a month, add a month to it and
% get a date relative to the end of the next month. The program also defines absolute
% days, the number of days since since 1st January 2001. And accordingly it provides
% relations to convert from modular dates to absolute days.
%
% This program is a part of a larger system for deriving various pieces of information on
% different financial arrangements, hire purchase arrangements being an example. This
% larger system uses absolute days to represent time internally because they are easier
% to manipulate with than Gregorian dates.
%
% Some facts about the Gregorian calendar, needed to count days between dates
%---------------------------------------------------------------------

/* are we able to express this with clpq? */
%leap_year(Year) :- 0 is mod(Year, 4), X is mod(Year, 100), X =\= 0.
%leap_year(Year) :- 0 is mod(Year, 400).
%?- findall(Y, (between(1000, 3000, Y), leap_year(Y),format('leap_year(~d).~n',[Y])), Ys).
leap_year(Y) :- nonvar(Y), Y < 1000, gtrace, throw(year_out_of_range).
leap_year(Y) :- nonvar(Y), Y > 3000, gtrace, throw(year_out_of_range).
leap_year(1004).
leap_year(1008).
leap_year(1012).
leap_year(1016).
leap_year(1020).
leap_year(1024).
leap_year(1028).
leap_year(1032).
leap_year(1036).
leap_year(1040).
leap_year(1044).
leap_year(1048).
leap_year(1052).
leap_year(1056).
leap_year(1060).
leap_year(1064).
leap_year(1068).
leap_year(1072).
leap_year(1076).
leap_year(1080).
leap_year(1084).
leap_year(1088).
leap_year(1092).
leap_year(1096).
leap_year(1104).
leap_year(1108).
leap_year(1112).
leap_year(1116).
leap_year(1120).
leap_year(1124).
leap_year(1128).
leap_year(1132).
leap_year(1136).
leap_year(1140).
leap_year(1144).
leap_year(1148).
leap_year(1152).
leap_year(1156).
leap_year(1160).
leap_year(1164).
leap_year(1168).
leap_year(1172).
leap_year(1176).
leap_year(1180).
leap_year(1184).
leap_year(1188).
leap_year(1192).
leap_year(1196).
leap_year(1200).
leap_year(1204).
leap_year(1208).
leap_year(1212).
leap_year(1216).
leap_year(1220).
leap_year(1224).
leap_year(1228).
leap_year(1232).
leap_year(1236).
leap_year(1240).
leap_year(1244).
leap_year(1248).
leap_year(1252).
leap_year(1256).
leap_year(1260).
leap_year(1264).
leap_year(1268).
leap_year(1272).
leap_year(1276).
leap_year(1280).
leap_year(1284).
leap_year(1288).
leap_year(1292).
leap_year(1296).
leap_year(1304).
leap_year(1308).
leap_year(1312).
leap_year(1316).
leap_year(1320).
leap_year(1324).
leap_year(1328).
leap_year(1332).
leap_year(1336).
leap_year(1340).
leap_year(1344).
leap_year(1348).
leap_year(1352).
leap_year(1356).
leap_year(1360).
leap_year(1364).
leap_year(1368).
leap_year(1372).
leap_year(1376).
leap_year(1380).
leap_year(1384).
leap_year(1388).
leap_year(1392).
leap_year(1396).
leap_year(1404).
leap_year(1408).
leap_year(1412).
leap_year(1416).
leap_year(1420).
leap_year(1424).
leap_year(1428).
leap_year(1432).
leap_year(1436).
leap_year(1440).
leap_year(1444).
leap_year(1448).
leap_year(1452).
leap_year(1456).
leap_year(1460).
leap_year(1464).
leap_year(1468).
leap_year(1472).
leap_year(1476).
leap_year(1480).
leap_year(1484).
leap_year(1488).
leap_year(1492).
leap_year(1496).
leap_year(1504).
leap_year(1508).
leap_year(1512).
leap_year(1516).
leap_year(1520).
leap_year(1524).
leap_year(1528).
leap_year(1532).
leap_year(1536).
leap_year(1540).
leap_year(1544).
leap_year(1548).
leap_year(1552).
leap_year(1556).
leap_year(1560).
leap_year(1564).
leap_year(1568).
leap_year(1572).
leap_year(1576).
leap_year(1580).
leap_year(1584).
leap_year(1588).
leap_year(1592).
leap_year(1596).
leap_year(1600).
leap_year(1604).
leap_year(1608).
leap_year(1612).
leap_year(1616).
leap_year(1620).
leap_year(1624).
leap_year(1628).
leap_year(1632).
leap_year(1636).
leap_year(1640).
leap_year(1644).
leap_year(1648).
leap_year(1652).
leap_year(1656).
leap_year(1660).
leap_year(1664).
leap_year(1668).
leap_year(1672).
leap_year(1676).
leap_year(1680).
leap_year(1684).
leap_year(1688).
leap_year(1692).
leap_year(1696).
leap_year(1704).
leap_year(1708).
leap_year(1712).
leap_year(1716).
leap_year(1720).
leap_year(1724).
leap_year(1728).
leap_year(1732).
leap_year(1736).
leap_year(1740).
leap_year(1744).
leap_year(1748).
leap_year(1752).
leap_year(1756).
leap_year(1760).
leap_year(1764).
leap_year(1768).
leap_year(1772).
leap_year(1776).
leap_year(1780).
leap_year(1784).
leap_year(1788).
leap_year(1792).
leap_year(1796).
leap_year(1804).
leap_year(1808).
leap_year(1812).
leap_year(1816).
leap_year(1820).
leap_year(1824).
leap_year(1828).
leap_year(1832).
leap_year(1836).
leap_year(1840).
leap_year(1844).
leap_year(1848).
leap_year(1852).
leap_year(1856).
leap_year(1860).
leap_year(1864).
leap_year(1868).
leap_year(1872).
leap_year(1876).
leap_year(1880).
leap_year(1884).
leap_year(1888).
leap_year(1892).
leap_year(1896).
leap_year(1904).
leap_year(1908).
leap_year(1912).
leap_year(1916).
leap_year(1920).
leap_year(1924).
leap_year(1928).
leap_year(1932).
leap_year(1936).
leap_year(1940).
leap_year(1944).
leap_year(1948).
leap_year(1952).
leap_year(1956).
leap_year(1960).
leap_year(1964).
leap_year(1968).
leap_year(1972).
leap_year(1976).
leap_year(1980).
leap_year(1984).
leap_year(1988).
leap_year(1992).
leap_year(1996).
leap_year(2000).
leap_year(2004).
leap_year(2008).
leap_year(2012).
leap_year(2016).
leap_year(2020).
leap_year(2024).
leap_year(2028).
leap_year(2032).
leap_year(2036).
leap_year(2040).
leap_year(2044).
leap_year(2048).
leap_year(2052).
leap_year(2056).
leap_year(2060).
leap_year(2064).
leap_year(2068).
leap_year(2072).
leap_year(2076).
leap_year(2080).
leap_year(2084).
leap_year(2088).
leap_year(2092).
leap_year(2096).
leap_year(2104).
leap_year(2108).
leap_year(2112).
leap_year(2116).
leap_year(2120).
leap_year(2124).
leap_year(2128).
leap_year(2132).
leap_year(2136).
leap_year(2140).
leap_year(2144).
leap_year(2148).
leap_year(2152).
leap_year(2156).
leap_year(2160).
leap_year(2164).
leap_year(2168).
leap_year(2172).
leap_year(2176).
leap_year(2180).
leap_year(2184).
leap_year(2188).
leap_year(2192).
leap_year(2196).
leap_year(2204).
leap_year(2208).
leap_year(2212).
leap_year(2216).
leap_year(2220).
leap_year(2224).
leap_year(2228).
leap_year(2232).
leap_year(2236).
leap_year(2240).
leap_year(2244).
leap_year(2248).
leap_year(2252).
leap_year(2256).
leap_year(2260).
leap_year(2264).
leap_year(2268).
leap_year(2272).
leap_year(2276).
leap_year(2280).
leap_year(2284).
leap_year(2288).
leap_year(2292).
leap_year(2296).
leap_year(2304).
leap_year(2308).
leap_year(2312).
leap_year(2316).
leap_year(2320).
leap_year(2324).
leap_year(2328).
leap_year(2332).
leap_year(2336).
leap_year(2340).
leap_year(2344).
leap_year(2348).
leap_year(2352).
leap_year(2356).
leap_year(2360).
leap_year(2364).
leap_year(2368).
leap_year(2372).
leap_year(2376).
leap_year(2380).
leap_year(2384).
leap_year(2388).
leap_year(2392).
leap_year(2396).
leap_year(2400).
leap_year(2404).
leap_year(2408).
leap_year(2412).
leap_year(2416).
leap_year(2420).
leap_year(2424).
leap_year(2428).
leap_year(2432).
leap_year(2436).
leap_year(2440).
leap_year(2444).
leap_year(2448).
leap_year(2452).
leap_year(2456).
leap_year(2460).
leap_year(2464).
leap_year(2468).
leap_year(2472).
leap_year(2476).
leap_year(2480).
leap_year(2484).
leap_year(2488).
leap_year(2492).
leap_year(2496).
leap_year(2504).
leap_year(2508).
leap_year(2512).
leap_year(2516).
leap_year(2520).
leap_year(2524).
leap_year(2528).
leap_year(2532).
leap_year(2536).
leap_year(2540).
leap_year(2544).
leap_year(2548).
leap_year(2552).
leap_year(2556).
leap_year(2560).
leap_year(2564).
leap_year(2568).
leap_year(2572).
leap_year(2576).
leap_year(2580).
leap_year(2584).
leap_year(2588).
leap_year(2592).
leap_year(2596).
leap_year(2604).
leap_year(2608).
leap_year(2612).
leap_year(2616).
leap_year(2620).
leap_year(2624).
leap_year(2628).
leap_year(2632).
leap_year(2636).
leap_year(2640).
leap_year(2644).
leap_year(2648).
leap_year(2652).
leap_year(2656).
leap_year(2660).
leap_year(2664).
leap_year(2668).
leap_year(2672).
leap_year(2676).
leap_year(2680).
leap_year(2684).
leap_year(2688).
leap_year(2692).
leap_year(2696).
leap_year(2704).
leap_year(2708).
leap_year(2712).
leap_year(2716).
leap_year(2720).
leap_year(2724).
leap_year(2728).
leap_year(2732).
leap_year(2736).
leap_year(2740).
leap_year(2744).
leap_year(2748).
leap_year(2752).
leap_year(2756).
leap_year(2760).
leap_year(2764).
leap_year(2768).
leap_year(2772).
leap_year(2776).
leap_year(2780).
leap_year(2784).
leap_year(2788).
leap_year(2792).
leap_year(2796).
leap_year(2800).
leap_year(2804).
leap_year(2808).
leap_year(2812).
leap_year(2816).
leap_year(2820).
leap_year(2824).
leap_year(2828).
leap_year(2832).
leap_year(2836).
leap_year(2840).
leap_year(2844).
leap_year(2848).
leap_year(2852).
leap_year(2856).
leap_year(2860).
leap_year(2864).
leap_year(2868).
leap_year(2872).
leap_year(2876).
leap_year(2880).
leap_year(2884).
leap_year(2888).
leap_year(2892).
leap_year(2896).
leap_year(2904).
leap_year(2908).
leap_year(2912).
leap_year(2916).
leap_year(2920).
leap_year(2924).
leap_year(2928).
leap_year(2932).
leap_year(2936).
leap_year(2940).
leap_year(2944).
leap_year(2948).
leap_year(2952).
leap_year(2956).
leap_year(2960).
leap_year(2964).
leap_year(2968).
leap_year(2972).
leap_year(2976).
leap_year(2980).
leap_year(2984).
leap_year(2988).
leap_year(2992).
leap_year(2996).


/*common_year(Year) :-
	((Y is mod(Year, 4), Y =\= 0); 0 is mod(Year, 100)),
	Z is mod(Year, 400), Z =\= 0.*/

%?- findall(Y, (between(1000, 3000, Y), common_year(Y),format('common_year(~d).~n',[Y])), Ys).
common_year(Y) :- nonvar(Y), Y < 1000, throw(year_out_of_range).
common_year(Y) :- nonvar(Y), Y > 3000, throw(year_out_of_range).
common_year(1000).
common_year(1001).
common_year(1002).
common_year(1003).
common_year(1005).
common_year(1006).
common_year(1007).
common_year(1009).
common_year(1010).
common_year(1011).
common_year(1013).
common_year(1014).
common_year(1015).
common_year(1017).
common_year(1018).
common_year(1019).
common_year(1021).
common_year(1022).
common_year(1023).
common_year(1025).
common_year(1026).
common_year(1027).
common_year(1029).
common_year(1030).
common_year(1031).
common_year(1033).
common_year(1034).
common_year(1035).
common_year(1037).
common_year(1038).
common_year(1039).
common_year(1041).
common_year(1042).
common_year(1043).
common_year(1045).
common_year(1046).
common_year(1047).
common_year(1049).
common_year(1050).
common_year(1051).
common_year(1053).
common_year(1054).
common_year(1055).
common_year(1057).
common_year(1058).
common_year(1059).
common_year(1061).
common_year(1062).
common_year(1063).
common_year(1065).
common_year(1066).
common_year(1067).
common_year(1069).
common_year(1070).
common_year(1071).
common_year(1073).
common_year(1074).
common_year(1075).
common_year(1077).
common_year(1078).
common_year(1079).
common_year(1081).
common_year(1082).
common_year(1083).
common_year(1085).
common_year(1086).
common_year(1087).
common_year(1089).
common_year(1090).
common_year(1091).
common_year(1093).
common_year(1094).
common_year(1095).
common_year(1097).
common_year(1098).
common_year(1099).
common_year(1100).
common_year(1101).
common_year(1102).
common_year(1103).
common_year(1105).
common_year(1106).
common_year(1107).
common_year(1109).
common_year(1110).
common_year(1111).
common_year(1113).
common_year(1114).
common_year(1115).
common_year(1117).
common_year(1118).
common_year(1119).
common_year(1121).
common_year(1122).
common_year(1123).
common_year(1125).
common_year(1126).
common_year(1127).
common_year(1129).
common_year(1130).
common_year(1131).
common_year(1133).
common_year(1134).
common_year(1135).
common_year(1137).
common_year(1138).
common_year(1139).
common_year(1141).
common_year(1142).
common_year(1143).
common_year(1145).
common_year(1146).
common_year(1147).
common_year(1149).
common_year(1150).
common_year(1151).
common_year(1153).
common_year(1154).
common_year(1155).
common_year(1157).
common_year(1158).
common_year(1159).
common_year(1161).
common_year(1162).
common_year(1163).
common_year(1165).
common_year(1166).
common_year(1167).
common_year(1169).
common_year(1170).
common_year(1171).
common_year(1173).
common_year(1174).
common_year(1175).
common_year(1177).
common_year(1178).
common_year(1179).
common_year(1181).
common_year(1182).
common_year(1183).
common_year(1185).
common_year(1186).
common_year(1187).
common_year(1189).
common_year(1190).
common_year(1191).
common_year(1193).
common_year(1194).
common_year(1195).
common_year(1197).
common_year(1198).
common_year(1199).
common_year(1201).
common_year(1202).
common_year(1203).
common_year(1205).
common_year(1206).
common_year(1207).
common_year(1209).
common_year(1210).
common_year(1211).
common_year(1213).
common_year(1214).
common_year(1215).
common_year(1217).
common_year(1218).
common_year(1219).
common_year(1221).
common_year(1222).
common_year(1223).
common_year(1225).
common_year(1226).
common_year(1227).
common_year(1229).
common_year(1230).
common_year(1231).
common_year(1233).
common_year(1234).
common_year(1235).
common_year(1237).
common_year(1238).
common_year(1239).
common_year(1241).
common_year(1242).
common_year(1243).
common_year(1245).
common_year(1246).
common_year(1247).
common_year(1249).
common_year(1250).
common_year(1251).
common_year(1253).
common_year(1254).
common_year(1255).
common_year(1257).
common_year(1258).
common_year(1259).
common_year(1261).
common_year(1262).
common_year(1263).
common_year(1265).
common_year(1266).
common_year(1267).
common_year(1269).
common_year(1270).
common_year(1271).
common_year(1273).
common_year(1274).
common_year(1275).
common_year(1277).
common_year(1278).
common_year(1279).
common_year(1281).
common_year(1282).
common_year(1283).
common_year(1285).
common_year(1286).
common_year(1287).
common_year(1289).
common_year(1290).
common_year(1291).
common_year(1293).
common_year(1294).
common_year(1295).
common_year(1297).
common_year(1298).
common_year(1299).
common_year(1300).
common_year(1301).
common_year(1302).
common_year(1303).
common_year(1305).
common_year(1306).
common_year(1307).
common_year(1309).
common_year(1310).
common_year(1311).
common_year(1313).
common_year(1314).
common_year(1315).
common_year(1317).
common_year(1318).
common_year(1319).
common_year(1321).
common_year(1322).
common_year(1323).
common_year(1325).
common_year(1326).
common_year(1327).
common_year(1329).
common_year(1330).
common_year(1331).
common_year(1333).
common_year(1334).
common_year(1335).
common_year(1337).
common_year(1338).
common_year(1339).
common_year(1341).
common_year(1342).
common_year(1343).
common_year(1345).
common_year(1346).
common_year(1347).
common_year(1349).
common_year(1350).
common_year(1351).
common_year(1353).
common_year(1354).
common_year(1355).
common_year(1357).
common_year(1358).
common_year(1359).
common_year(1361).
common_year(1362).
common_year(1363).
common_year(1365).
common_year(1366).
common_year(1367).
common_year(1369).
common_year(1370).
common_year(1371).
common_year(1373).
common_year(1374).
common_year(1375).
common_year(1377).
common_year(1378).
common_year(1379).
common_year(1381).
common_year(1382).
common_year(1383).
common_year(1385).
common_year(1386).
common_year(1387).
common_year(1389).
common_year(1390).
common_year(1391).
common_year(1393).
common_year(1394).
common_year(1395).
common_year(1397).
common_year(1398).
common_year(1399).
common_year(1400).
common_year(1401).
common_year(1402).
common_year(1403).
common_year(1405).
common_year(1406).
common_year(1407).
common_year(1409).
common_year(1410).
common_year(1411).
common_year(1413).
common_year(1414).
common_year(1415).
common_year(1417).
common_year(1418).
common_year(1419).
common_year(1421).
common_year(1422).
common_year(1423).
common_year(1425).
common_year(1426).
common_year(1427).
common_year(1429).
common_year(1430).
common_year(1431).
common_year(1433).
common_year(1434).
common_year(1435).
common_year(1437).
common_year(1438).
common_year(1439).
common_year(1441).
common_year(1442).
common_year(1443).
common_year(1445).
common_year(1446).
common_year(1447).
common_year(1449).
common_year(1450).
common_year(1451).
common_year(1453).
common_year(1454).
common_year(1455).
common_year(1457).
common_year(1458).
common_year(1459).
common_year(1461).
common_year(1462).
common_year(1463).
common_year(1465).
common_year(1466).
common_year(1467).
common_year(1469).
common_year(1470).
common_year(1471).
common_year(1473).
common_year(1474).
common_year(1475).
common_year(1477).
common_year(1478).
common_year(1479).
common_year(1481).
common_year(1482).
common_year(1483).
common_year(1485).
common_year(1486).
common_year(1487).
common_year(1489).
common_year(1490).
common_year(1491).
common_year(1493).
common_year(1494).
common_year(1495).
common_year(1497).
common_year(1498).
common_year(1499).
common_year(1500).
common_year(1501).
common_year(1502).
common_year(1503).
common_year(1505).
common_year(1506).
common_year(1507).
common_year(1509).
common_year(1510).
common_year(1511).
common_year(1513).
common_year(1514).
common_year(1515).
common_year(1517).
common_year(1518).
common_year(1519).
common_year(1521).
common_year(1522).
common_year(1523).
common_year(1525).
common_year(1526).
common_year(1527).
common_year(1529).
common_year(1530).
common_year(1531).
common_year(1533).
common_year(1534).
common_year(1535).
common_year(1537).
common_year(1538).
common_year(1539).
common_year(1541).
common_year(1542).
common_year(1543).
common_year(1545).
common_year(1546).
common_year(1547).
common_year(1549).
common_year(1550).
common_year(1551).
common_year(1553).
common_year(1554).
common_year(1555).
common_year(1557).
common_year(1558).
common_year(1559).
common_year(1561).
common_year(1562).
common_year(1563).
common_year(1565).
common_year(1566).
common_year(1567).
common_year(1569).
common_year(1570).
common_year(1571).
common_year(1573).
common_year(1574).
common_year(1575).
common_year(1577).
common_year(1578).
common_year(1579).
common_year(1581).
common_year(1582).
common_year(1583).
common_year(1585).
common_year(1586).
common_year(1587).
common_year(1589).
common_year(1590).
common_year(1591).
common_year(1593).
common_year(1594).
common_year(1595).
common_year(1597).
common_year(1598).
common_year(1599).
common_year(1601).
common_year(1602).
common_year(1603).
common_year(1605).
common_year(1606).
common_year(1607).
common_year(1609).
common_year(1610).
common_year(1611).
common_year(1613).
common_year(1614).
common_year(1615).
common_year(1617).
common_year(1618).
common_year(1619).
common_year(1621).
common_year(1622).
common_year(1623).
common_year(1625).
common_year(1626).
common_year(1627).
common_year(1629).
common_year(1630).
common_year(1631).
common_year(1633).
common_year(1634).
common_year(1635).
common_year(1637).
common_year(1638).
common_year(1639).
common_year(1641).
common_year(1642).
common_year(1643).
common_year(1645).
common_year(1646).
common_year(1647).
common_year(1649).
common_year(1650).
common_year(1651).
common_year(1653).
common_year(1654).
common_year(1655).
common_year(1657).
common_year(1658).
common_year(1659).
common_year(1661).
common_year(1662).
common_year(1663).
common_year(1665).
common_year(1666).
common_year(1667).
common_year(1669).
common_year(1670).
common_year(1671).
common_year(1673).
common_year(1674).
common_year(1675).
common_year(1677).
common_year(1678).
common_year(1679).
common_year(1681).
common_year(1682).
common_year(1683).
common_year(1685).
common_year(1686).
common_year(1687).
common_year(1689).
common_year(1690).
common_year(1691).
common_year(1693).
common_year(1694).
common_year(1695).
common_year(1697).
common_year(1698).
common_year(1699).
common_year(1700).
common_year(1701).
common_year(1702).
common_year(1703).
common_year(1705).
common_year(1706).
common_year(1707).
common_year(1709).
common_year(1710).
common_year(1711).
common_year(1713).
common_year(1714).
common_year(1715).
common_year(1717).
common_year(1718).
common_year(1719).
common_year(1721).
common_year(1722).
common_year(1723).
common_year(1725).
common_year(1726).
common_year(1727).
common_year(1729).
common_year(1730).
common_year(1731).
common_year(1733).
common_year(1734).
common_year(1735).
common_year(1737).
common_year(1738).
common_year(1739).
common_year(1741).
common_year(1742).
common_year(1743).
common_year(1745).
common_year(1746).
common_year(1747).
common_year(1749).
common_year(1750).
common_year(1751).
common_year(1753).
common_year(1754).
common_year(1755).
common_year(1757).
common_year(1758).
common_year(1759).
common_year(1761).
common_year(1762).
common_year(1763).
common_year(1765).
common_year(1766).
common_year(1767).
common_year(1769).
common_year(1770).
common_year(1771).
common_year(1773).
common_year(1774).
common_year(1775).
common_year(1777).
common_year(1778).
common_year(1779).
common_year(1781).
common_year(1782).
common_year(1783).
common_year(1785).
common_year(1786).
common_year(1787).
common_year(1789).
common_year(1790).
common_year(1791).
common_year(1793).
common_year(1794).
common_year(1795).
common_year(1797).
common_year(1798).
common_year(1799).
common_year(1800).
common_year(1801).
common_year(1802).
common_year(1803).
common_year(1805).
common_year(1806).
common_year(1807).
common_year(1809).
common_year(1810).
common_year(1811).
common_year(1813).
common_year(1814).
common_year(1815).
common_year(1817).
common_year(1818).
common_year(1819).
common_year(1821).
common_year(1822).
common_year(1823).
common_year(1825).
common_year(1826).
common_year(1827).
common_year(1829).
common_year(1830).
common_year(1831).
common_year(1833).
common_year(1834).
common_year(1835).
common_year(1837).
common_year(1838).
common_year(1839).
common_year(1841).
common_year(1842).
common_year(1843).
common_year(1845).
common_year(1846).
common_year(1847).
common_year(1849).
common_year(1850).
common_year(1851).
common_year(1853).
common_year(1854).
common_year(1855).
common_year(1857).
common_year(1858).
common_year(1859).
common_year(1861).
common_year(1862).
common_year(1863).
common_year(1865).
common_year(1866).
common_year(1867).
common_year(1869).
common_year(1870).
common_year(1871).
common_year(1873).
common_year(1874).
common_year(1875).
common_year(1877).
common_year(1878).
common_year(1879).
common_year(1881).
common_year(1882).
common_year(1883).
common_year(1885).
common_year(1886).
common_year(1887).
common_year(1889).
common_year(1890).
common_year(1891).
common_year(1893).
common_year(1894).
common_year(1895).
common_year(1897).
common_year(1898).
common_year(1899).
common_year(1900).
common_year(1901).
common_year(1902).
common_year(1903).
common_year(1905).
common_year(1906).
common_year(1907).
common_year(1909).
common_year(1910).
common_year(1911).
common_year(1913).
common_year(1914).
common_year(1915).
common_year(1917).
common_year(1918).
common_year(1919).
common_year(1921).
common_year(1922).
common_year(1923).
common_year(1925).
common_year(1926).
common_year(1927).
common_year(1929).
common_year(1930).
common_year(1931).
common_year(1933).
common_year(1934).
common_year(1935).
common_year(1937).
common_year(1938).
common_year(1939).
common_year(1941).
common_year(1942).
common_year(1943).
common_year(1945).
common_year(1946).
common_year(1947).
common_year(1949).
common_year(1950).
common_year(1951).
common_year(1953).
common_year(1954).
common_year(1955).
common_year(1957).
common_year(1958).
common_year(1959).
common_year(1961).
common_year(1962).
common_year(1963).
common_year(1965).
common_year(1966).
common_year(1967).
common_year(1969).
common_year(1970).
common_year(1971).
common_year(1973).
common_year(1974).
common_year(1975).
common_year(1977).
common_year(1978).
common_year(1979).
common_year(1981).
common_year(1982).
common_year(1983).
common_year(1985).
common_year(1986).
common_year(1987).
common_year(1989).
common_year(1990).
common_year(1991).
common_year(1993).
common_year(1994).
common_year(1995).
common_year(1997).
common_year(1998).
common_year(1999).
common_year(2001).
common_year(2002).
common_year(2003).
common_year(2005).
common_year(2006).
common_year(2007).
common_year(2009).
common_year(2010).
common_year(2011).
common_year(2013).
common_year(2014).
common_year(2015).
common_year(2017).
common_year(2018).
common_year(2019).
common_year(2021).
common_year(2022).
common_year(2023).
common_year(2025).
common_year(2026).
common_year(2027).
common_year(2029).
common_year(2030).
common_year(2031).
common_year(2033).
common_year(2034).
common_year(2035).
common_year(2037).
common_year(2038).
common_year(2039).
common_year(2041).
common_year(2042).
common_year(2043).
common_year(2045).
common_year(2046).
common_year(2047).
common_year(2049).
common_year(2050).
common_year(2051).
common_year(2053).
common_year(2054).
common_year(2055).
common_year(2057).
common_year(2058).
common_year(2059).
common_year(2061).
common_year(2062).
common_year(2063).
common_year(2065).
common_year(2066).
common_year(2067).
common_year(2069).
common_year(2070).
common_year(2071).
common_year(2073).
common_year(2074).
common_year(2075).
common_year(2077).
common_year(2078).
common_year(2079).
common_year(2081).
common_year(2082).
common_year(2083).
common_year(2085).
common_year(2086).
common_year(2087).
common_year(2089).
common_year(2090).
common_year(2091).
common_year(2093).
common_year(2094).
common_year(2095).
common_year(2097).
common_year(2098).
common_year(2099).
common_year(2100).
common_year(2101).
common_year(2102).
common_year(2103).
common_year(2105).
common_year(2106).
common_year(2107).
common_year(2109).
common_year(2110).
common_year(2111).
common_year(2113).
common_year(2114).
common_year(2115).
common_year(2117).
common_year(2118).
common_year(2119).
common_year(2121).
common_year(2122).
common_year(2123).
common_year(2125).
common_year(2126).
common_year(2127).
common_year(2129).
common_year(2130).
common_year(2131).
common_year(2133).
common_year(2134).
common_year(2135).
common_year(2137).
common_year(2138).
common_year(2139).
common_year(2141).
common_year(2142).
common_year(2143).
common_year(2145).
common_year(2146).
common_year(2147).
common_year(2149).
common_year(2150).
common_year(2151).
common_year(2153).
common_year(2154).
common_year(2155).
common_year(2157).
common_year(2158).
common_year(2159).
common_year(2161).
common_year(2162).
common_year(2163).
common_year(2165).
common_year(2166).
common_year(2167).
common_year(2169).
common_year(2170).
common_year(2171).
common_year(2173).
common_year(2174).
common_year(2175).
common_year(2177).
common_year(2178).
common_year(2179).
common_year(2181).
common_year(2182).
common_year(2183).
common_year(2185).
common_year(2186).
common_year(2187).
common_year(2189).
common_year(2190).
common_year(2191).
common_year(2193).
common_year(2194).
common_year(2195).
common_year(2197).
common_year(2198).
common_year(2199).
common_year(2200).
common_year(2201).
common_year(2202).
common_year(2203).
common_year(2205).
common_year(2206).
common_year(2207).
common_year(2209).
common_year(2210).
common_year(2211).
common_year(2213).
common_year(2214).
common_year(2215).
common_year(2217).
common_year(2218).
common_year(2219).
common_year(2221).
common_year(2222).
common_year(2223).
common_year(2225).
common_year(2226).
common_year(2227).
common_year(2229).
common_year(2230).
common_year(2231).
common_year(2233).
common_year(2234).
common_year(2235).
common_year(2237).
common_year(2238).
common_year(2239).
common_year(2241).
common_year(2242).
common_year(2243).
common_year(2245).
common_year(2246).
common_year(2247).
common_year(2249).
common_year(2250).
common_year(2251).
common_year(2253).
common_year(2254).
common_year(2255).
common_year(2257).
common_year(2258).
common_year(2259).
common_year(2261).
common_year(2262).
common_year(2263).
common_year(2265).
common_year(2266).
common_year(2267).
common_year(2269).
common_year(2270).
common_year(2271).
common_year(2273).
common_year(2274).
common_year(2275).
common_year(2277).
common_year(2278).
common_year(2279).
common_year(2281).
common_year(2282).
common_year(2283).
common_year(2285).
common_year(2286).
common_year(2287).
common_year(2289).
common_year(2290).
common_year(2291).
common_year(2293).
common_year(2294).
common_year(2295).
common_year(2297).
common_year(2298).
common_year(2299).
common_year(2300).
common_year(2301).
common_year(2302).
common_year(2303).
common_year(2305).
common_year(2306).
common_year(2307).
common_year(2309).
common_year(2310).
common_year(2311).
common_year(2313).
common_year(2314).
common_year(2315).
common_year(2317).
common_year(2318).
common_year(2319).
common_year(2321).
common_year(2322).
common_year(2323).
common_year(2325).
common_year(2326).
common_year(2327).
common_year(2329).
common_year(2330).
common_year(2331).
common_year(2333).
common_year(2334).
common_year(2335).
common_year(2337).
common_year(2338).
common_year(2339).
common_year(2341).
common_year(2342).
common_year(2343).
common_year(2345).
common_year(2346).
common_year(2347).
common_year(2349).
common_year(2350).
common_year(2351).
common_year(2353).
common_year(2354).
common_year(2355).
common_year(2357).
common_year(2358).
common_year(2359).
common_year(2361).
common_year(2362).
common_year(2363).
common_year(2365).
common_year(2366).
common_year(2367).
common_year(2369).
common_year(2370).
common_year(2371).
common_year(2373).
common_year(2374).
common_year(2375).
common_year(2377).
common_year(2378).
common_year(2379).
common_year(2381).
common_year(2382).
common_year(2383).
common_year(2385).
common_year(2386).
common_year(2387).
common_year(2389).
common_year(2390).
common_year(2391).
common_year(2393).
common_year(2394).
common_year(2395).
common_year(2397).
common_year(2398).
common_year(2399).
common_year(2401).
common_year(2402).
common_year(2403).
common_year(2405).
common_year(2406).
common_year(2407).
common_year(2409).
common_year(2410).
common_year(2411).
common_year(2413).
common_year(2414).
common_year(2415).
common_year(2417).
common_year(2418).
common_year(2419).
common_year(2421).
common_year(2422).
common_year(2423).
common_year(2425).
common_year(2426).
common_year(2427).
common_year(2429).
common_year(2430).
common_year(2431).
common_year(2433).
common_year(2434).
common_year(2435).
common_year(2437).
common_year(2438).
common_year(2439).
common_year(2441).
common_year(2442).
common_year(2443).
common_year(2445).
common_year(2446).
common_year(2447).
common_year(2449).
common_year(2450).
common_year(2451).
common_year(2453).
common_year(2454).
common_year(2455).
common_year(2457).
common_year(2458).
common_year(2459).
common_year(2461).
common_year(2462).
common_year(2463).
common_year(2465).
common_year(2466).
common_year(2467).
common_year(2469).
common_year(2470).
common_year(2471).
common_year(2473).
common_year(2474).
common_year(2475).
common_year(2477).
common_year(2478).
common_year(2479).
common_year(2481).
common_year(2482).
common_year(2483).
common_year(2485).
common_year(2486).
common_year(2487).
common_year(2489).
common_year(2490).
common_year(2491).
common_year(2493).
common_year(2494).
common_year(2495).
common_year(2497).
common_year(2498).
common_year(2499).
common_year(2500).
common_year(2501).
common_year(2502).
common_year(2503).
common_year(2505).
common_year(2506).
common_year(2507).
common_year(2509).
common_year(2510).
common_year(2511).
common_year(2513).
common_year(2514).
common_year(2515).
common_year(2517).
common_year(2518).
common_year(2519).
common_year(2521).
common_year(2522).
common_year(2523).
common_year(2525).
common_year(2526).
common_year(2527).
common_year(2529).
common_year(2530).
common_year(2531).
common_year(2533).
common_year(2534).
common_year(2535).
common_year(2537).
common_year(2538).
common_year(2539).
common_year(2541).
common_year(2542).
common_year(2543).
common_year(2545).
common_year(2546).
common_year(2547).
common_year(2549).
common_year(2550).
common_year(2551).
common_year(2553).
common_year(2554).
common_year(2555).
common_year(2557).
common_year(2558).
common_year(2559).
common_year(2561).
common_year(2562).
common_year(2563).
common_year(2565).
common_year(2566).
common_year(2567).
common_year(2569).
common_year(2570).
common_year(2571).
common_year(2573).
common_year(2574).
common_year(2575).
common_year(2577).
common_year(2578).
common_year(2579).
common_year(2581).
common_year(2582).
common_year(2583).
common_year(2585).
common_year(2586).
common_year(2587).
common_year(2589).
common_year(2590).
common_year(2591).
common_year(2593).
common_year(2594).
common_year(2595).
common_year(2597).
common_year(2598).
common_year(2599).
common_year(2600).
common_year(2601).
common_year(2602).
common_year(2603).
common_year(2605).
common_year(2606).
common_year(2607).
common_year(2609).
common_year(2610).
common_year(2611).
common_year(2613).
common_year(2614).
common_year(2615).
common_year(2617).
common_year(2618).
common_year(2619).
common_year(2621).
common_year(2622).
common_year(2623).
common_year(2625).
common_year(2626).
common_year(2627).
common_year(2629).
common_year(2630).
common_year(2631).
common_year(2633).
common_year(2634).
common_year(2635).
common_year(2637).
common_year(2638).
common_year(2639).
common_year(2641).
common_year(2642).
common_year(2643).
common_year(2645).
common_year(2646).
common_year(2647).
common_year(2649).
common_year(2650).
common_year(2651).
common_year(2653).
common_year(2654).
common_year(2655).
common_year(2657).
common_year(2658).
common_year(2659).
common_year(2661).
common_year(2662).
common_year(2663).
common_year(2665).
common_year(2666).
common_year(2667).
common_year(2669).
common_year(2670).
common_year(2671).
common_year(2673).
common_year(2674).
common_year(2675).
common_year(2677).
common_year(2678).
common_year(2679).
common_year(2681).
common_year(2682).
common_year(2683).
common_year(2685).
common_year(2686).
common_year(2687).
common_year(2689).
common_year(2690).
common_year(2691).
common_year(2693).
common_year(2694).
common_year(2695).
common_year(2697).
common_year(2698).
common_year(2699).
common_year(2700).
common_year(2701).
common_year(2702).
common_year(2703).
common_year(2705).
common_year(2706).
common_year(2707).
common_year(2709).
common_year(2710).
common_year(2711).
common_year(2713).
common_year(2714).
common_year(2715).
common_year(2717).
common_year(2718).
common_year(2719).
common_year(2721).
common_year(2722).
common_year(2723).
common_year(2725).
common_year(2726).
common_year(2727).
common_year(2729).
common_year(2730).
common_year(2731).
common_year(2733).
common_year(2734).
common_year(2735).
common_year(2737).
common_year(2738).
common_year(2739).
common_year(2741).
common_year(2742).
common_year(2743).
common_year(2745).
common_year(2746).
common_year(2747).
common_year(2749).
common_year(2750).
common_year(2751).
common_year(2753).
common_year(2754).
common_year(2755).
common_year(2757).
common_year(2758).
common_year(2759).
common_year(2761).
common_year(2762).
common_year(2763).
common_year(2765).
common_year(2766).
common_year(2767).
common_year(2769).
common_year(2770).
common_year(2771).
common_year(2773).
common_year(2774).
common_year(2775).
common_year(2777).
common_year(2778).
common_year(2779).
common_year(2781).
common_year(2782).
common_year(2783).
common_year(2785).
common_year(2786).
common_year(2787).
common_year(2789).
common_year(2790).
common_year(2791).
common_year(2793).
common_year(2794).
common_year(2795).
common_year(2797).
common_year(2798).
common_year(2799).
common_year(2801).
common_year(2802).
common_year(2803).
common_year(2805).
common_year(2806).
common_year(2807).
common_year(2809).
common_year(2810).
common_year(2811).
common_year(2813).
common_year(2814).
common_year(2815).
common_year(2817).
common_year(2818).
common_year(2819).
common_year(2821).
common_year(2822).
common_year(2823).
common_year(2825).
common_year(2826).
common_year(2827).
common_year(2829).
common_year(2830).
common_year(2831).
common_year(2833).
common_year(2834).
common_year(2835).
common_year(2837).
common_year(2838).
common_year(2839).
common_year(2841).
common_year(2842).
common_year(2843).
common_year(2845).
common_year(2846).
common_year(2847).
common_year(2849).
common_year(2850).
common_year(2851).
common_year(2853).
common_year(2854).
common_year(2855).
common_year(2857).
common_year(2858).
common_year(2859).
common_year(2861).
common_year(2862).
common_year(2863).
common_year(2865).
common_year(2866).
common_year(2867).
common_year(2869).
common_year(2870).
common_year(2871).
common_year(2873).
common_year(2874).
common_year(2875).
common_year(2877).
common_year(2878).
common_year(2879).
common_year(2881).
common_year(2882).
common_year(2883).
common_year(2885).
common_year(2886).
common_year(2887).
common_year(2889).
common_year(2890).
common_year(2891).
common_year(2893).
common_year(2894).
common_year(2895).
common_year(2897).
common_year(2898).
common_year(2899).
common_year(2900).
common_year(2901).
common_year(2902).
common_year(2903).
common_year(2905).
common_year(2906).
common_year(2907).
common_year(2909).
common_year(2910).
common_year(2911).
common_year(2913).
common_year(2914).
common_year(2915).
common_year(2917).
common_year(2918).
common_year(2919).
common_year(2921).
common_year(2922).
common_year(2923).
common_year(2925).
common_year(2926).
common_year(2927).
common_year(2929).
common_year(2930).
common_year(2931).
common_year(2933).
common_year(2934).
common_year(2935).
common_year(2937).
common_year(2938).
common_year(2939).
common_year(2941).
common_year(2942).
common_year(2943).
common_year(2945).
common_year(2946).
common_year(2947).
common_year(2949).
common_year(2950).
common_year(2951).
common_year(2953).
common_year(2954).
common_year(2955).
common_year(2957).
common_year(2958).
common_year(2959).
common_year(2961).
common_year(2962).
common_year(2963).
common_year(2965).
common_year(2966).
common_year(2967).
common_year(2969).
common_year(2970).
common_year(2971).
common_year(2973).
common_year(2974).
common_year(2975).
common_year(2977).
common_year(2978).
common_year(2979).
common_year(2981).
common_year(2982).
common_year(2983).
common_year(2985).
common_year(2986).
common_year(2987).
common_year(2989).
common_year(2990).
common_year(2991).
common_year(2993).
common_year(2994).
common_year(2995).
common_year(2997).
common_year(2998).
common_year(2999).
common_year(3000).


days_in(_, 1, 31).
days_in(Year, 2, 29) :- leap_year(Year).
days_in(Year, 2, 28) :- common_year(Year).
days_in(_, 3, 31).
days_in(_, 4, 30).
days_in(_, 5, 31).
days_in(_, 6, 30).
days_in(_, 7, 31).
days_in(_, 8, 31).
days_in(_, 9, 30).
days_in(_, 10, 31).
days_in(_, 11, 30).
days_in(_, 12, 31).

/* handles dates in a limited amount of non-normal forms */
days_in(Year, Month, Days) :-
	{Month =< 0,
	Closer_Year = Year - 1,
	Closer_Year_Month = 12 + Month},
	days_in(Closer_Year, Closer_Year_Month, Days).

days_in(Year, Month, Days) :-
	{Month > 12,
	Closer_Year = Year + 1,
	Closer_Year_Month = Month - 12},
	days_in(Closer_Year, Closer_Year_Month, Days).


% -------------------------------------------------------------------
% A generalized date, date(Y, M, D), means the same thing as a normal date when its value
% is that of a normal date. In addition date(2006, 0, 1) refers to the month before
% date(2006, 1, 1), date(2006, -1, 1) to the month before that, etc. Also date(2006, 5, 0)
% refers to the day before date(2006, 5, 1), date(2006, 5, -1) to the day before that,
% etc. Months have precedence over days. Useful for specifying that payments happen at
% month-ends.
% -------------------------------------------------------------------

date_add(date(A, B, C), date(D, E, F), date(G, H, I)) :-
	{G = A + D},
	{H = B + E},
	{I = C + F}.


% -------------------------------------------------------------------
% The following predicate relates a date to which day it is in the year
% -------------------------------------------------------------------

year_day(date(_, 1, Day), Day).

year_day(date(Year, Month, Day), Year_Day) :-
	{Month > 1,
	Prev_Month = Month - 1,
	Year_Day = Day_A + Day - 1 + Day_B},
	year_day(date(Year, Prev_Month, 1), Day_A),
	days_in(Year, Prev_Month, Day_B).

year_day(date(Year, Month, Day), Year_Day) :-
	{Month < 1,
	Next_Month = Month + 1,
	Year_Day = Day_A + Day - 1 - Day_B},
	year_day(date(Year, Next_Month, 1), Day_A),
	days_in(Year, Month, Day_B).


% -------------------------------------------------------------------
% The following predicate relates a year day to its month and month day
% -------------------------------------------------------------------

month_day(Year, Year_Day, Month, Month_Day) :-
	/*Month_Lower is ((Year_Day - 1) div 31) + 1, % Lowest possible month for given day
	Month_Upper is ((Year_Day - 1) div 28) + 1, % Highest possible month for given day
	between(Month_Lower, Month_Upper, Month), % The right month is somewhere between
	*/
	year_day(date(Year, Month, 1), Month_Start_Year_Day),
	days_in(Year, Month, Month_Length),
	{Month_End_Year_Day = Month_Start_Year_Day + Month_Length - 1,
	Month_Start_Year_Day =< Year_Day, Year_Day =< Month_End_Year_Day,
	Month_Day = Year_Day + 1 - Month_Start_Year_Day}.


% -------------------------------------------------------------------
% absolute day count since 1st January 0001
% -------------------------------------------------------------------

absolute_day(date(Year, Month, Day), Abs_Day) :-
	Month_A is (Year - 1) * 12 + (Month - 1),
	Num_400Y is Month_A div (400 * 12),
	Num_100Y is Month_A div (100 * 12),
	Num_4Y is Month_A div (4 * 12),
	Num_1Y is Month_A div (1 * 12),
	Years_Day is (Num_1Y * 365) + (Num_4Y * 1) - (Num_100Y * 1) + (Num_400Y * 1),
	Month_B is 1 + (Month_A mod 12),
	Num_1Y_Plus_1 is Num_1Y + 1,
	year_day(date(Num_1Y_Plus_1, Month_B, Day), Year_Day),
	{Abs_Day = Years_Day + Year_Day}.

gregorian_date(Abs_Day, date(Year, Month, Day)) :-
	Days_1Y is 365,
	Days_4Y is (4 * Days_1Y) + 1,
	Days_100Y is (25 * Days_4Y) - 1,
	Days_400Y is (4 * Days_100Y) + 1,
	Num_400Y is (Abs_Day - 1) div Days_400Y,
	Num_100Y is ((Abs_Day - 1) mod Days_400Y) div Days_100Y,
	Num_4Y is (((Abs_Day - 1) mod Days_400Y) mod Days_100Y) div Days_4Y,
	Num_1Y is ((((Abs_Day - 1) mod Days_400Y) mod Days_100Y) mod Days_4Y) div Days_1Y,
	Year_Day is 1 + (((((Abs_Day - 1) mod Days_400Y) mod Days_100Y) mod Days_4Y) mod Days_1Y),
	Year is 1 + (400 * Num_400Y) + (100 * Num_100Y) + (4 * Num_4Y) + (1 * Num_1Y),
	month_day(Year, Year_Day, Month, Day).


% -------------------------------------------------------------------
% Predicate asserts that the given absolute day resides between two Gregorian dates
% -------------------------------------------------------------------

day_between(Opening_Date, Closing_Date, Day) :-
	gregorian_date(Day, Date),
	date_between(Opening_Date, Closing_Date, Date).

date_between(
	/*inputs*/
	Opening_Date, 
	Closing_Date, 
	Date
) :-
	/* todo check that all uses of this pred intend to cut off the end date */
	absolute_day(Opening_Date, Opening_Day),
	absolute_day(Closing_Date, Closing_Day),
	absolute_day(Date, Day),
	{Opening_Day =< Day}, {Day < Closing_Day}.

date_within(
	/*inputs*/
	Opening_Date,
	Closing_Date,
	Date
) :-
	absolute_day(Opening_Date, Opening_Day),
	absolute_day(Closing_Date, Closing_Day),
	absolute_day(Date, Day),
	Opening_Day =< Day, Day =< Closing_Day.


% Finds the difference of 2 dates in day format
day_diff(Date1, Date2, Days) :-
	absolute_day(Date1, Days1),
	absolute_day(Date2, Days2),
	Days is Days2 - Days1.

% -------------------------------------------------------------------
% parses date in "DD-MM-YYYY" format
% -------------------------------------------------------------------

parse_date_into_absolute_days(DateString, Absolute_Days) :-
	parse_date(DateString, YMD),
	absolute_day(YMD, Absolute_Days).
	
parse_date(DateString, YMD) :-
	(
		parse_time(DateString, iso_8601, UnixTimestamp),
		stamp_date_time(UnixTimestamp, DateTime, 'UTC'), 
		date_time_value(date, DateTime, YMD)
	)
	->
		true
	;
		throw_string(['failed parsing date:', DateString]).

format_date(Date, DateString) :-
	format_time(string(DateString), '%Y-%m-%d', Date).

add_days(Date, Absolute_Days, Date2) :-
	absolute_day(Date, Day),
	Day2 is Day + Absolute_Days,
	gregorian_date(Day2, Date2).

date_in_request_period(Date) :-
	request_has_property(l:start_date, Start_Date),
	request_has_property(l:end_date, End_Date),
	date_within(Start_Date, End_Date, Date).

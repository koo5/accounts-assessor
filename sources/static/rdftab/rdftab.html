<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8"/>

	<script type="text/javascript" src="vue.js"></script>
	<script type="text/javascript" src="jquery-3.4.0.js"></script>
	<script src="lodash.js"></script>
	<script type="text/javascript" src="vue-truncate-collapsed.js"></script>

	<link rel="stylesheet" href="styles.css">
</head>
<body>

<div id="top">
	<!--  style="float:left; height:100%" -->
	<node :node="node"></node>
</div>

<script type="text/javascript">
	'use strict';

	function node(uri)
	{
		this.uri = uri;
		this.props = [{a: "b"}];
		this.sources=[{msg: "loading..."}];
	}

	Vue.component('node', {
		props: ['node'],
		template: `
			<div>
				<small>identifier</small>
				<b>
				  <term v-if="node.term" :term="node.term"></term>
				  <span v-else>
            {{ node.uri }}
            </span>
				</b>
				<small>and its relations:</small>
				<span v-for="source in node.sources">
				  <template v-if="source.msg!='loaded'">
					  <small>({{ source.msg }})</small>
					</template>
				</span>
				
				<table>
					<thead>
						<tr>
							<th>property</th>
							<th>value</th>
            </tr>
          </thead>
          <tbody>  
          

          <tr v-for="prop in node.props">
          <td>
          <term :term="prop.p"/>
          </td>
          <td>
          <term :term="prop.o"/>
          </td>
          </tr>
				</ul>
			</div>
		`,
		methods: {}
	});

	Vue.component('term', {
		props: ['term'],
		template: `
			<span v-if="term.str">
        {{ term.str }}
      </span>
			<span v-elif="term.label">
			  {{ term.label }}
      </span>
      <span v-else>
        {{ term.short }}
      </span>
		`,
		methods: {}
	});

  

	function load_node_data_all(node)
	{
		Promise.all([
			load_node_data1(node.uri).then(
						results => {
							assign_node_data1(node, results);
							node.sources[0].msg = 'loaded';
						}
						).catch(
							(error) => {node.sources[0].msg = "error: " + error;})
		]);
	};

	function load_node_data1(uri) {
		return new Promise(
			function(resolve, reject)
			{
				var url = '/api/rdftab?uri='+encodeURIComponent(uri);
				$.ajax({
					dataType: "json",
					mimeType: "application/json",
					url: url,
					success: function(data){
					    resolve(data);
					},
					error: function() {
						reject("loading "+url+" failed");
					}
				});
			}
		);
	}

	function assign_node_data1(node, result)
	{
		console.log("assign_node_data1");
		console.log(result);
		//node.props.push(result.props);
		for (var key in result) {
      if (result.hasOwnProperty(key)) {
        node[key] = result[key];
      }
    }
	}
	
	const searchParams = new URLSearchParams(window.location.search);
	const uri = searchParams.get('uri').trim('<').trim('>'); //fixme

	var vm = new Vue({
		el: '#top',
		data: {
			node: new node(uri)
		},
		mounted: function ()
		{
			console.log( "mounted!" );
			load_node_data_all(this.node);
		}
	});

</script>
</body>
</html>

